#!/bin/sh

set -e

# Source debconf library.
. /usr/share/debconf/confmodule

# remember the formerly used (or default) group names, if any
db_get x2goserver-desktopsharing/group-sharing && db_set x2goserver-desktopsharing/last-group-sharing $RET || true

# set the confirmation questions for group deletions always to false before we begin...
db_set x2goserver-desktopsharing/del-last-group-sharing false

db_input high x2goserver-desktopsharing/create-group-for-sharing || true
db_go
db_get x2goserver-desktopsharing/create-group-for-sharing
create_group=$RET

# always allow usage of existing group (also when $create_group is set)
db_set x2goserver-desktopsharing/use-existing-group-for-sharing true
if [ "$create_group" = "false" ]; then

	db_get x2goserver-desktopsharing/group-sharing
	if [ -z "$RET" ] || ! getent group $RET 1>/dev/null; then
		db_set x2goserver-desktopsharing/group-sharing "root"
	fi

	db_input high x2goserver-desktopsharing/use-existing-group-for-sharing || true
	db_go
fi

db_get x2goserver-desktopsharing/use-existing-group-for-sharing
use_existing_group=$RET

if [ "$create_group" = "true" ] || [ "$use_existing_group" = "true" ]; then

	loop=1
	while [ $loop -eq 1 ]; do
		db_input high x2goserver-desktopsharing/group-sharing || true
		db_go

		db_get x2goserver-desktopsharing/group-sharing
		group_sharing=$RET
		if getent group $group_sharing 1>/dev/null; then
			loop=0
		else
			if [ "$create_group" = "true" ]; then
				loop=0
			else
				db_input critical x2goserver-desktopsharing/no-such-group || true
				db_go
				continue
			fi
		fi

		db_get x2goserver-desktopsharing/last-group-sharing
		if [ -z "$RET" ] || ! getent group $RET 1>/dev/null; then
			RET="root"
		fi
		if [ "$RET" != "$group_sharing" ] && [ $(getent group $RET | cut -d ":" -f 3) -ge 100 ]; then
			db_input critical x2goserver-desktopsharing/del-last-group-sharing || true
			db_go
		fi
	done
fi

db_input high x2goserver-desktopsharing/auto-start-on-logon || true
db_go
db_get x2goserver-desktopsharing/auto-start-on-logon
auto_start=$RET

if [ "$auto_start" = "true" ]; then
	db_input high x2goserver-desktopsharing/auto-activate-on-logon || true
	db_go
fi
