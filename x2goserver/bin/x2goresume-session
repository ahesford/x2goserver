#!/bin/bash

# Copyright (C) 2007-2011 X2go Project - http://wiki.x2go.org
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the
# Free Software Foundation, Inc.,
# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
#
# Copyright (C) 2007-2011  Oleksandr Shneyder <oleksandr.shneyder@obviously-nice.de>
# Copyright (C) 2007-2011  Heinz-Markus Graesing <heinz-m.graesing@obviously-nice.de>

SESSION_NAME=$1
X2GO_GEOMETRY=$2
X2GO_LINK=$3
X2GO_PACK=$4
X2GO_KBD_LAYOUT=$5
X2GO_KBD_TYPE=$6
X2GO_SET_KBD=$7

X2GO_LIB_PATH=`echo -n \$(x2gobasepath)/lib/x2go`
X2GO_AGENT_PID=`$X2GO_LIB_PATH/x2gogetagent $SESSION_NAME`

X2GO_ROOT=${HOME}/.x2go
X2GO_RESIZE=0
X2GO_FULLSCREEN=0

$X2GO_LIB_PATH/x2gosyslog "$0" "info" "$(basename $0) called with options: $@"

if [ "$X2GO_GEOMETRY" == "" ]
then
	X2GO_GEOMETRY=fullscreen
fi

if [ "$X2GO_GEOMETRY" == "fullscreen" ]
then
	X2GO_RESIZE=1
	X2GO_FULLSCREEN=1
fi

SESSION_DIR=${X2GO_ROOT}/C-${SESSION_NAME}
OPTIONS=`cat ${SESSION_DIR}/options`

GSTR=`echo "$OPTIONS" | awk -F, {'print $13'}`
RSTR=`echo "$OPTIONS" | awk -F, {'print $14'}`
FSTR=`echo "$OPTIONS" | awk -F, {'print $15'}`
LSTR=`echo "$OPTIONS" | awk -F, {'print $2'}`
PSTR=`echo "$OPTIONS" | awk -F, {'print $3'}`
KTSTR=`echo "$OPTIONS" | awk -F, {'print $12'}`

KTSTR=`echo $KTSTR | sed "s/\//\\\\\\\\\//"`
X2GO_KBD_TYPE=`echo $X2GO_KBD_TYPE | sed "s/\//\\\\\\\\\//"`

if [ "$X2GO_SET_KBD" == "0" ]
then
	X2GO_KBD_TYPE="null\/null"
fi

NEWOPTIONS=`echo "$OPTIONS" | sed  -e  "s/$LSTR/link=$X2GO_LINK/"\
 -e "s/$PSTR/pack=$X2GO_PACK/"\
 -e "s/$KTSTR/kbtype=$X2GO_KBD_TYPE/"\
 -e "s/$GSTR/geometry=$X2GO_GEOMETRY/"\
 -e "s/$RSTR/resize=$X2GO_RESIZE/"\
 -e "s/$FSTR/fullscreen=$X2GO_FULLSCREEN/"`

X2GO_CLIENT=`echo $SSH_CLIENT | awk '{print $1}'`
if [ "$X2GO_CLIENT" == "" ]
then
	X2GO_CLIENT=$HOSTNAME
fi

echo "$NEWOPTIONS" >${SESSION_DIR}/options

$X2GO_LIB_PATH/x2goresume  $X2GO_CLIENT $SESSION_NAME  > /dev/null

kill -HUP $X2GO_AGENT_PID &>/dev/null && {
	$X2GO_LIB_PATH/x2gosyslog "$0" "notice" "client $X2GO_CLIENT has successfully resumed session with ID $SESSION_NAME"
} || {
	err_msg="ERROR: failed to resume session with ID $SESSION_NAME"
	echo "$err_msg" 1>&2
	$X2GO_LIB_PATH/x2gosyslog "$0" "err" "$err_msg"

	# If we reach here it means that the x2goagent process of the session has vanisshed
	# If this happens than we mark the session as finished...
	$X2GO_LIB_PATH/x2gochangestatus 'F' $SESSION_NAME  > /dev/null
}

# resume x2godesktopsharing, if it has been in use before the session got suspended
x2gofeature X2GO_DESKTOPSHARING &>/dev/null && x2godesktopsharing_resume $SESSION_NAME
